/*
 0BSD
*/
(function(){function L(m,g){var k=new Uint8Array(2*f);k.set(g,f);k.set(m);return k}function C(f,g){var k;(k=new Uint8Array(2+g.length)).set(g,2);(new DataView(k.buffer)).setUint16(0,f,!1);return k}function v(m,g,k,v){function D(a){var b;var c=a.subarray(0,f);var d=(a[f]||0)*(f+1);var e=a.subarray(f+1,f+1+d);e.length!==e.length&&(e=y);a=a.subarray(f+1+d);if(a.length%f)a=[];else{d=[];var h=0;for(b=a.length/f;h<b;++h){var n=h;d.push(a.subarray(f*n,f*(n+1)))}a=d}return[c,e,a]}function p(a){if(!(this instanceof
p))return new p(a);this.f=a;this.a=E()}function l(a,b,c,d,e,f){var h=this;null==e&&(e=.2);null==f&&(f={});if(!(this instanceof l))return new l(a,b,c,d,e,f);k.call(this);this.c=Object.assign({},M,f);this.b=v(a,w,b,c,e);this.s=b;this.l=g.random_int(0,Math.pow(2,16)-1);this.m=new Map;this.j=new Set;this.o=p(d);this.f=E();this.G=N(this.c.STATE_UPDATE_INTERVAL,function(){var a,b;var c=0;for(b=(a=h.b.get_state()[2]).length;c<b;++c){var d=a[c];h.B(d)}})}var w=m.blake2b_256;var O=m.sign;var P=m.verify;var u=
g.are_arrays_equal;var G=g.concat_arrays;var Q=g.timeoutSet;var N=g.intervalSet;var E=g.ArrayMap;var r=g.error_handler;var y=new Uint8Array(0);p.prototype={add:function(a,b){if(this.a.has(a))this.a["delete"](a);this.a.set(a,b);if(this.a.size>this.f)this.a["delete"](this.a.keys().next().value)},get:function(a){var b;if(b=this.a.get(a))this.a["delete"](a),this.a.set(a,b);return b}};Object.defineProperty(p.prototype,"constructor",{value:p});l.prototype={receive:function(a,b,c){if(!this.a){var d=[(new DataView(c.buffer,
c.byteOffset,c.byteLength)).getUint16(0,!1),c.subarray(2)];c=d[0];d=d[1];switch(b){case H:(c=this.m.get(c))&&c(a,d);break;case A:d.length||(d=null,this.b.commit_state());(b=this.F(d))&&this.u(a,c,b);break;case I:d=[d.subarray(0,f),d.subarray(f)];b=d[0];d=d[1];this.u(a,c,this.b.get_state_proof(b,d));break;case J:b=this.o.get(d);this.u(a,c,b||y);break;case K:d=[d.subarray(0,f),d.subarray(f)],b=d[0],c=d[1],this.verify_value(b,c)?this.o.add(b,c):this.h(a)}}},lookup:function(a,b){var c,d=this;null==b&&
(b=this.s);if(this.a)return Promise.reject();if(c=this.f.get(a))return c;c=this.w(a,this.b.start_lookup(a,b));c["catch"](r);this.f.set(a,c);c.then(function(){d.f["delete"](a)})["catch"](function(){d.f["delete"](a)});return c},w:function(a,b){var c=this;return this.a?Promise.reject():new Promise(function(d,e){function f(){t--;if(!t)c.w(a,z).then(d)["catch"](e)}function g(b){var c=this;var d=b[0];var e=b[1];var h=b[2];this.g(e,I,L(h,d),this.c.GET_PROOF_REQUEST_TIMEOUT).then(function(b){var g;if(g=c.b.check_state_proof(h,
b,d))return c.C(d,e).then(function(){return c.g(d,A,g,c.c.GET_STATE_REQUEST_TIMEOUT).then(D).then(function(b){var e=b[0];var h=b[1];b=b[2];h=c.b.check_state_proof(e,h,d);u(g,e)&&h&&u(h,d)?z=z.concat(c.b.update_lookup(a,d,g,b)):c.h(d);f()})["catch"](function(a){r(a);c.i(d);f()})});c.h(e);f()})["catch"](function(a){r(a);c.i(e);f()})}var F;if(b.length){var z=[];var t=b.length;var q=0;for(F=b.length;q<F;++q)g.call(c,b[q])}else(q=c.b.finish_lookup(a))?d(q):e()})},h:function(a){this.fire("peer_error",a);
this.del_peer(a)},i:function(a){this.fire("peer_warning",a)},C:function(a,b){return this.fire("connect_to",a,b)},F:function(a){null==a&&(a=null);if(this.a)return y;var b=this.b.get_state(a);a=b[0];var c=b[1];b=b[2];var d=c.length/(f+1);b=G(b);var e=new Uint8Array(f+1+c.length+b.length);e.set(a);e.set([d],f);e.set(c,f+1);e.set(b,f+1+c.length);return e},get_peers:function(){return this.a?[]:this.b.get_state()[2]},add_peer:function(a){this.a||this.b.has_peer(a)||this.B(a)},del_peer:function(a){this.a||
this.b.del_peer(a)},get_value:function(a,b){var c,d=this;null==b&&(b=this.s);if(this.a)return Promise.reject();if((c=this.o.get(a))&&u(w(c),a))return Promise.resolve(c);b=this.lookup(a,b).then(function(b){return new Promise(function(e,f){function h(){l||(k--,k||(n?e(n[1]):f()))}function g(b){if(!l)if(b.length)if(u(w(b),a))l=!0,e(b);else{if(b=d.v(a,b)){if(!n||n[0]<b[0])n=b}else d.h(p);h()}else h()}function t(a){r(a);d.i(p);h()}var q;var k=b.length;var l=!1;var n=c?d.v(a,c):null;b.length||(n?e(n[1]):
f());var m=0;for(q=b.length;m<q;++m){var p=b[m];d.g(p,J,a,d.c.GET_VALUE_TIMEOUT).then(g)["catch"](t)}})});b["catch"](r);return b},v:function(a,b){if(b.length<B+5)return null;var c=b.subarray(0,b.length-B);return P(b.subarray(b.length-B),c,a)?[(new DataView(c.buffer,c.byteOffset,c.byteLength)).getUint32(0,!1),c.subarray(4)]:null},make_immutable_value:function(a){return a.length>x?null:[w(a),a]},make_mutable_value:function(a,b,c,d){var e;if(d.length>x)return null;(e=new Uint8Array(4+d.length)).set(d,
4);(new DataView(e.buffer)).setUint32(0,c,!1);b=O(e,a,b);e=G([e,b]);return[a,e]},verify_value:function(a,b){return u(w(b),a)&&b.length<=x?b:(a=this.v(a,b))&&a[1].length<=x?a[1]:null},put_value:function(a,b,c){var d=this;null==c&&(c=this.s);if(this.a||!this.verify_value(a,b))return Promise.reject();this.o.add(a,b);return this.lookup(a,c).then(function(c){var e,g=[];if(c.length){var k=new Uint8Array(f+b.length);k.set(a);k.set(b,f);var l=0;for(e=c.length;l<e;++l){var t=c[l];g.push(d.g(t,K,k,d.c.PUT_VALUE_TIMEOUT))}return g}})},
destroy:function(){if(!this.a)return this.a=!0,this.j.forEach(clearTimeout),clearInterval(this.G)},g:function(a,b,c,d){var e=this;var f=new Promise(function(f,g){var h=e.D();e.m.set(h,function(a,b){u(a,a)&&(clearTimeout(k),e.j["delete"](k),e.m["delete"](h),f(b))});var k=Q(d,function(){e.m["delete"](h);e.j["delete"](k);g()});e.j.add(k);e.A(a,b,C(h,c))});f["catch"](r);return f},u:function(a,b,c){this.A(a,H,C(b,c))},D:function(){var a=this.l;this.l++;this.l===Math.pow(2,16)&&(this.l=0);return a},A:function(a,
b,c){this.fire("send",a,b,c)},B:function(a){var b=this;this.g(a,A,y,this.c.GET_STATE_REQUEST_TIMEOUT).then(function(c){var d=D(c);c=d[0];var e=d[1];d=d[2];b.b.set_peer(a,c,e,d)?b.fire("peer_updated",a,d):b.h(a)})["catch"](function(c){r(c);b.i(a)})}};l.prototype=Object.assign(Object.create(k.prototype),l.prototype);Object.defineProperty(l.prototype,"constructor",{value:l});return{ready:m.ready,DHT:l,MAX_VALUE_LENGTH:x}}var f=32;var B=64;var H=0;var A=1;var I=2;var J=3;var K=4;var M={GET_PROOF_REQUEST_TIMEOUT:5,
GET_STATE_REQUEST_TIMEOUT:10,GET_VALUE_TIMEOUT:5,PUT_VALUE_TIMEOUT:5,STATE_UPDATE_INTERVAL:15};var x=1024;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/utils","async-eventer","es-dht"],v):"object"===typeof exports?module.exports=v(require("@detox/crypto"),require("@detox/utils"),require("async-eventer"),require("es-dht")):this.detox_dht=v(this.detox_crypto,this.detox_utils,"async_eventer",this.es_dht)}).call(this);