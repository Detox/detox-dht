/*
 0BSD
*/
(function(){function I(n,g){var h=new Uint8Array(2*f);h.set(g,f);h.set(n);return h}function B(f,g){var h;(h=new Uint8Array(2+g.length)).set(g,2);(new DataView(h.buffer)).setUint16(0,f,!1);return h}function p(n,g,h,p){function C(b){var a;var c=b.subarray(0,f);var d=(b[f]||0)*(f+1);var e=b.subarray(f+1,f+1+d);e.length!==e.length&&(e=w);b=b.subarray(f+1+d);if(b.length%f)b=[];else{d=[];var l=0;for(a=b.length/f;l<a;++l){var x=l;d.push(b.subarray(f*x,f*(x+1)))}b=d}return[c,e,b]}function m(b){if(!(this instanceof
m))return new m(b);this.g=b;this.a=J()}function k(b,a,c,d,e,f){var l=this;null==e&&(e=.2);null==f&&(f={});if(!(this instanceof k))return new k(b,a,c,d,e,f);h.call(this);this.f=Object.assign({},K,f);this.b=p(b,u,a,c,e);this.j=g.random_int(0,Math.pow(2,16)-1);this.l=new Map;this.g=new Set;this.m=m(d);this.C=L(this.f.STATE_UPDATE_INTERVAL,function(){function b(b){var a=this;this.h(b,y,w,this.f.GET_STATE_REQUEST_TIMEOUT).then(function(c){a.set_peer(b,c)||a.c(b)})["catch"](function(a){v(a);this.i(b)})}
var a,c;var d=0;for(c=(a=l.get_peers()).length;d<c;++d)b.call(l,a[d])})}var u=n.blake2b_256;var M=n.sign;var N=n.verify;var t=g.are_arrays_equal;var D=g.concat_arrays;var O=g.timeoutSet;var L=g.intervalSet;var J=g.ArrayMap;var v=g.error_handler;var w=new Uint8Array(0);m.prototype={add:function(b,a){if(this.a.has(b))this.a["delete"](b);this.a.set(b,a);if(this.a.size>this.g)this.a["delete"](this.a.keys().next().value)},get:function(b){var a;if(a=this.a.get(b))this.a["delete"](b),this.a.set(b,a);return a}};
Object.defineProperty(m.prototype,"constructor",{value:m});k.prototype={receive:function(b,a,c){if(!this.a){var d=[(new DataView(c.buffer,c.byteOffset,c.byteLength)).getUint16(0,!1),c.subarray(2)];c=d[0];d=d[1];switch(a){case E:(c=this.l.get(c))&&c(b,d);break;case y:d.length||(d=null);(a=this.u(d))&&this.o(b,c,a);break;case F:d=[d.subarray(0,f),d.subarray(f)];a=d[0];d=d[1];this.o(b,c,this.b.get_state_proof(a,d));break;case G:a=this.m.get(d);this.o(b,c,a||w);break;case H:d=[d.subarray(0,f),d.subarray(f)],
a=d[0],c=d[1],this.verify_value(a,c)?this.m.add(a,c):this.c(b)}}},lookup:function(b){return this.a?Promise.reject():this.v(b,this.b.start_lookup(b))},v:function(b,a){var c=this;return this.a?Promise.reject():new Promise(function(d,e){function f(){h--;h||c.v(b,z).then(d)}function x(a){var c=this;var d=a[0];var e=a[1];var g=a[2];this.h(e,F,I(g,d),this.f.GET_PROOF_REQUEST_TIMEOUT).then(function(a){var l;(l=c.b.check_state_proof(g,a,d))?c.A(d,e).then(function(){return c.h(d,y,l,c.f.GET_STATE_REQUEST_TIMEOUT).then(C).then(function(a){var e=
a[0];var g=a[1];a=a[2];g=c.b.check_state_proof(e,g,d);t(l,e)&&g&&t(g,d)?z=z.concat(c.b.update_lookup(b,d,l,a)):c.c(d);f()})["catch"](function(b){v(b);this.i(d);f()})}):(c.c(e),f())})["catch"](function(b){v(b);this.i(e);f()})}var g;if(a.length){var z=[];var h=a.length;e=0;for(g=a.length;e<g;++e)x.call(c,a[e])}else(g=c.b.finish_lookup(b))?d(g):e()})},c:function(b){this.fire("peer_error",b);this.del_peer(b)},i:function(b){this.fire("peer_warning",b)},A:function(b,a){return this.fire("connect_to",b,a)},
get_state:function(){return this.u()},u:function(b){null==b&&(b=null);if(this.a)return w;var a=this.b.get_state(b);b=a[0];var c=a[1];a=a[2];var d=c.length/(f+1);a=D(a);var e=new Uint8Array(f+1+c.length+a.length);e.set(b);e.set([d],f);e.set(c,f+1);e.set(a,f+1+c.length);return e},get_peers:function(){return this.a?[]:this.b.get_state()[2]},set_peer:function(b,a){if(this.a)return!1;a=C(a);(a=this.b.set_peer(b,a[0],a[1],a[2]))||this.c(b);return a},has_peer:function(b){return this.a?!1:this.b.has_peer(b)},
del_peer:function(b){this.a||this.b.del_peer(b)},get_value:function(b){var a,c=this;return this.a?Promise.reject():(a=this.m.get(b))&&t(u(a),b)?Promise.resolve(a):this.lookup(b).then(function(d){return new Promise(function(e,f){function g(){m||(n--,n||(r?e(r[1]):f()))}function l(a){if(!m)if(a.length)if(t(u(a),b))m=!0,e(a);else{if(a=c.s(b,a)){if(!r||r[0]<a[0])r=a}else c.c(q);g()}else g()}function h(a){v(a);this.i(q);g()}var k;var n=d.length;var m=!1;var r=a?c.s(b,a):null;d.length||(r?e(r[1]):f());
var p=0;for(k=d.length;p<k;++p){var q=d[p];c.h(q,G,b,c.f.GET_VALUE_TIMEOUT).then(l)["catch"](h)}})})},s:function(b,a){if(a.length<A+5)return null;var c=a.subarray(0,a.length-A);return N(a.subarray(a.length-A),c,b)?[(new DataView(c.buffer,c.byteOffset,c.byteLength)).getUint32(0,!1),c.subarray(4)]:null},make_immutable_value:function(b){return b.length>q?null:[u(b),b]},make_mutable_value:function(b,a,c,d){var e;if(d.length>q)return null;(e=new Uint8Array(4+d.length)).set(d,4);(new DataView(e.buffer)).setUint32(0,
c,!1);a=M(e,b,a);e=D([e,a]);return[b,e]},verify_value:function(b,a){return t(u(a),b)&&a.length<=q?a:(b=this.s(b,a))&&b[1].length<=q?b[1]:null},put_value:function(b,a){var c=this;if(this.a||!this.verify_value(b,a))return Promise.reject();this.m.add(b,a);return this.lookup(b).then(function(d){var e,g=[];if(d.length){var h=new Uint8Array(f+a.length);h.set(b);h.set(a,f);var k=0;for(e=d.length;k<e;++k){var m=d[k];g.push(c.h(m,H,h,c.f.PUT_VALUE_TIMEOUT))}return g}})},destroy:function(){if(!this.a)return this.a=
!0,this.g.forEach(clearTimeout),clearInterval(this.C)},h:function(b,a,c,d){var e=this;var f=new Promise(function(f,g){var h=e.B();e.l.set(h,function(a,b){t(a,a)&&(clearTimeout(k),e.g["delete"](k),e.l["delete"](h),f(b))});var k=O(d,function(){e.l["delete"](h);e.g["delete"](k);g()});e.g.add(k);e.w(b,a,B(h,c))});f["catch"](v);return f},o:function(b,a,c){this.w(b,E,B(a,c))},B:function(){var b=this.j;this.j++;this.j===Math.pow(2,16)&&(this.j=0);return b},w:function(b,a,c){this.fire("send",b,a,c)}};k.prototype=
Object.assign(Object.create(h.prototype),k.prototype);Object.defineProperty(k.prototype,"constructor",{value:k});return{ready:n.ready,DHT:k,MAX_VALUE_LENGTH:q}}var f=32;var A=64;var E=0;var y=1;var F=2;var G=3;var H=4;var K={GET_PROOF_REQUEST_TIMEOUT:5,GET_STATE_REQUEST_TIMEOUT:10,GET_VALUE_TIMEOUT:5,PUT_VALUE_TIMEOUT:5,STATE_UPDATE_INTERVAL:15};var q=1024;"function"===typeof define&&define.amd?define(["@detox/crypto","@detox/utils","async-eventer","es-dht"],p):"object"===typeof exports?module.exports=
p(require("@detox/crypto"),require("@detox/utils"),require("async-eventer"),require("es-dht")):this.detox_dht=p(this.detox_crypto,this.detox_utils,"async_eventer",this.es_dht)}).call(this);